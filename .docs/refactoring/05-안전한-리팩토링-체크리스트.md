# 안전한 리팩토링 체크리스트

## 개요

리팩토링은 위험한 작업일 수 있습니다. 이 체크리스트는 리팩토링을 안전하게 수행하기 위한 단계별 가이드를 제공합니다.

## 🚦 리팩토링 전 확인사항

### 1. 현재 상태 점검
- [ ] 모든 테스트가 통과하는가?
  ```bash
  uv run pytest tests/ -v
  ```
- [ ] 현재 테스트 커버리지는 얼마인가?
  ```bash
  uv run pytest --cov --cov-report=term-missing
  ```
- [ ] CI 파이프라인이 정상 작동하는가?
  ```bash
  gh run list --limit 5
  ```
- [ ] 작업 브랜치가 최신 상태인가?
  ```bash
  git pull origin main
  git checkout -b refactor/descriptive-name
  ```

### 2. 리팩토링 범위 정의
- [ ] 무엇을 리팩토링할 것인가? (구체적으로 명시)
- [ ] 왜 리팩토링이 필요한가? (목적 명확히)
- [ ] 예상 소요 시간은? (1시간 이상이면 분할 고려)
- [ ] 영향받는 모듈/기능은? (의존성 파악)

### 3. 안전장치 준비
- [ ] 특성화 테스트 작성 (현재 동작 문서화)
  ```python
  def test_current_behavior():
      """리팩토링 전 동작을 정확히 기록"""
      # 모든 입력과 출력을 캡처
  ```
- [ ] 리팩토링 시작점 커밋
  ```bash
  git add -A
  git commit -m "chore: checkpoint before refactoring"
  ```

## 📋 점진적 리팩토링 단계

### Phase 1: 이해와 분석 (Read-Only)
```bash
# 1. 코드 구조 파악
find src -name "*.py" | xargs wc -l | sort -n

# 2. 의존성 분석
grep -r "import.*module_name" src/

# 3. 테스트 커버리지 상세 확인
uv run pytest tests/test_target_module.py --cov=target_module --cov-report=html
```

### Phase 2: 최소 단위 변경
```python
# 예시: 하나의 함수 추출
# Step 1: 새 함수 생성 (기존 코드 복사)
def extracted_function(params):
    # 기존 코드 그대로 복사
    pass

# Step 2: 기존 위치에서 새 함수 호출
def original_function():
    # ...
    result = extracted_function(params)
    # ...

# Step 3: 테스트 실행
# uv run pytest tests/
```

### Phase 3: 검증
- [ ] 단위 테스트 실행
  ```bash
  uv run pytest tests/test_affected_module.py -v
  ```
- [ ] 통합 테스트 실행
  ```bash
  uv run pytest tests/ -v
  ```
- [ ] 수동 테스트 (필요시)
- [ ] 커밋
  ```bash
  git add -p  # 변경사항 검토
  git commit -m "refactor: extract function_name for clarity"
  ```

## 🔄 리팩토링 패턴별 체크리스트

### Extract Method (메서드 추출)
- [ ] 추출할 코드 블록 식별
- [ ] 필요한 파라미터 확인
- [ ] 반환값 결정
- [ ] 새 메서드 생성 및 테스트
- [ ] 원본에서 새 메서드 호출
- [ ] 모든 테스트 통과 확인

### Rename (이름 변경)
- [ ] 영향 범위 검색
  ```bash
  grep -r "old_name" src/ tests/
  ```
- [ ] IDE의 리팩토링 도구 사용 (가능한 경우)
- [ ] 수동으로 놓친 부분 확인
- [ ] import 문 업데이트
- [ ] 문서/주석 업데이트

### Move Method/Class (이동)
- [ ] 새 위치에 파일/클래스 생성
- [ ] 기존 위치에서 import 제공 (하위 호환성)
  ```python
  # old_module.py
  from new_module import MovedClass  # 하위 호환성 유지
  ```
- [ ] 테스트 실행
- [ ] 점진적으로 참조 업데이트
- [ ] 최종적으로 이전 위치 제거

### Split Module (모듈 분할)
- [ ] 응집도 기준으로 그룹화
- [ ] 순환 의존성 확인
- [ ] 공개 API 유지 (re-export)
- [ ] 각 분할 단계마다 테스트

## 🚨 위험 신호와 대응

### 테스트 실패 시
```bash
# 1. 즉시 중단
# 2. 실패 원인 분석
uv run pytest tests/failed_test.py -vv

# 3. 마지막 성공 지점으로 복구
git diff  # 변경사항 검토
git checkout -- .  # 또는 특정 파일만

# 4. 더 작은 단계로 재시도
```

### 예상치 못한 동작
- [ ] 변경사항 최소화했는가?
- [ ] 숨겨진 의존성이 있는가?
- [ ] 부작용을 놓쳤는가?
- [ ] 롤백 후 재분석

### 성능 저하
```python
# 리팩토링 전후 성능 측정
import time

start = time.time()
result = function_to_measure()
end = time.time()
print(f"Execution time: {end - start}s")
```

## 📊 리팩토링 후 검증

### 1. 자동화된 검증
```bash
# 전체 테스트 스위트
uv run pytest tests/ -v

# 코드 품질 검사
uv run ruff check src/ tests/
uv run black --check src/ tests/

# 타입 검사 (설정된 경우)
uv run mypy src/
```

### 2. 커버리지 확인
```bash
# 커버리지가 떨어지지 않았는지 확인
uv run pytest --cov --cov-fail-under=85
```

### 3. CI/CD 파이프라인
```bash
# PR 생성 후 CI 확인
gh pr create --title "refactor: improve module structure"
gh pr checks
```

### 4. 성능 벤치마크
- [ ] 주요 기능 응답 시간
- [ ] 메모리 사용량
- [ ] CPU 사용률

## 💡 베스트 프랙티스

### 커밋 전략
```bash
# 작은 의미 있는 커밋
git add src/specific_file.py
git commit -m "refactor: extract validation logic"

git add tests/test_specific.py
git commit -m "test: add tests for extracted validation"

# 관련 커밋 스쿼시 (필요시)
git rebase -i HEAD~n
```

### 리뷰 준비
- [ ] PR 설명에 리팩토링 이유 명시
- [ ] Before/After 코드 스니펫 포함
- [ ] 테스트 결과 스크린샷
- [ ] 성능 영향 분석 (있다면)

### 문서화
```markdown
## Refactoring: Module Split

### Why
- File exceeded 500 lines
- Mixed responsibilities

### What Changed
- Split `big_module.py` into:
  - `core.py`: Core logic
  - `utils.py`: Helper functions
  - `types.py`: Data structures

### Verification
- All tests pass
- Coverage maintained at 88%
- No public API changes
```

## 🔄 지속적 개선

### 리팩토링 후 회고
- [ ] 목표를 달성했는가?
- [ ] 예상 시간 내에 완료했는가?
- [ ] 어떤 어려움이 있었는가?
- [ ] 다음에는 무엇을 다르게 할 것인가?

### 팀 공유
- [ ] 배운 점 문서화
- [ ] 팀 미팅에서 공유
- [ ] 체크리스트 개선 제안

## 🎯 체크리스트 요약

```python
def safe_refactoring_checklist():
    """리팩토링 시작 전 실행"""

    steps = [
        "1. ✅ 모든 테스트 통과 확인",
        "2. 📸 현재 상태 스냅샷 (git commit)",
        "3. 🎯 명확한 목표 설정",
        "4. 🔍 영향 범위 분석",
        "5. 📝 특성화 테스트 작성",
        "6. 🔄 작은 단계로 진행",
        "7. ✅ 각 단계마다 테스트",
        "8. 💾 의미 있는 커밋",
        "9. 🚨 실패 시 즉시 롤백",
        "10. 📊 최종 검증"
    ]

    for step in steps:
        print(f"[ ] {step}")

    return "\n안전한 리팩토링을 위해 각 단계를 확인하세요!"
```

기억하세요: **리팩토링의 첫 번째 규칙은 "동작하는 코드를 망가뜨리지 않는 것"입니다.**
